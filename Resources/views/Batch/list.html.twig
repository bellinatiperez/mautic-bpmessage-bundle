{% extends '@MauticCore/Default/content.html.twig' %}

{% block headerTitle %}{{ 'mautic.bpmessage.lot.header.index'|trans }}{% endblock %}

{% block actions %}{% endblock %}

{% block content %}
<div class="pa-md">
    {# Statistics Cards #}
    <div class="row mb-3">
        <div class="col-md-2">
            <div class="panel panel-default">
                <div class="panel-body text-center">
                    <h2>{{ statistics.total|default(0) }}</h2>
                    <p class="text-muted mb-0">{{ 'mautic.bpmessage.stats.total'|trans }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="panel panel-default">
                <div class="panel-body text-center">
                    <h2>{{ statistics.creating|default(0) }}</h2>
                    <p class="text-muted mb-0">{{ 'mautic.bpmessage.lot.status.creating'|trans }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="panel panel-default">
                <div class="panel-body text-center">
                    <h2>{{ statistics.open|default(0) }}</h2>
                    <p class="text-muted mb-0">{{ 'mautic.bpmessage.lot.status.open'|trans }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="panel panel-default">
                <div class="panel-body text-center">
                    <h2>{{ statistics.finished|default(0) }}</h2>
                    <p class="text-muted mb-0">{{ 'mautic.bpmessage.lot.status.finished'|trans }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="panel panel-default">
                <div class="panel-body text-center">
                    <h2>{{ statistics.failed|default(0) }}</h2>
                    <p class="text-muted mb-0">{{ 'mautic.bpmessage.lot.status.failed'|trans }}</p>
                </div>
            </div>
        </div>
    </div>

    {# Filters #}
    <div class="panel panel-default mb-3">
        <div class="panel-body">
            <form method="get" action="{{ path('mautic_bpmessage_lot_index') }}">
                <div class="row">
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>{{ 'mautic.bpmessage.filter.status'|trans }}</label>
                            <select name="status" class="form-control" onchange="this.form.submit()">
                                <option value="">{{ 'mautic.bpmessage.filter.all'|trans }}</option>
                                <option value="CREATING" {% if filterStatus == 'CREATING' %}selected{% endif %}>{{ 'mautic.bpmessage.lot.status.creating'|trans }}</option>
                                <option value="OPEN" {% if filterStatus == 'OPEN' %}selected{% endif %}>{{ 'mautic.bpmessage.lot.status.open'|trans }}</option>
                                <option value="FINISHED" {% if filterStatus == 'FINISHED' %}selected{% endif %}>{{ 'mautic.bpmessage.lot.status.finished'|trans }}</option>
                                <option value="FAILED" {% if filterStatus == 'FAILED' %}selected{% endif %}>{{ 'mautic.bpmessage.lot.status.failed'|trans }}</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>{{ 'mautic.bpmessage.filter.type'|trans }}</label>
                            <select name="type" class="form-control" onchange="this.form.submit()">
                                <option value="">{{ 'mautic.bpmessage.filter.all'|trans }}</option>
                                <option value="email" {% if filterType == 'email' %}selected{% endif %}>{{ 'mautic.bpmessage.filter.type.email'|trans }}</option>
                                <option value="whatsapp" {% if filterType == 'whatsapp' %}selected{% endif %}>{{ 'mautic.bpmessage.filter.type.whatsapp'|trans }}</option>
                                <option value="sms" {% if filterType == 'sms' %}selected{% endif %}>{{ 'mautic.bpmessage.filter.type.sms'|trans }}</option>
                                <option value="rcs" {% if filterType == 'rcs' %}selected{% endif %}>{{ 'mautic.bpmessage.filter.type.rcs'|trans }}</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>{{ 'mautic.bpmessage.filter.campaign'|trans }}</label>
                            <select name="campaign_id" class="form-control" onchange="this.form.submit()">
                                <option value="">{{ 'mautic.bpmessage.filter.all_campaigns'|trans }}</option>
                                {% for id, name in campaigns %}
                                    <option value="{{ id }}" {% if filterCampaign == id %}selected{% endif %}>
                                        {{ name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>{{ 'mautic.bpmessage.filter.period'|trans }}</label>
                            <select name="days" class="form-control" id="days-filter" onchange="handleDaysChange(this)">
                                <option value="0" {% if filterDays == 0 and not filterDateFrom and not filterDateTo %}selected{% endif %}>{{ 'mautic.bpmessage.filter.all_time'|trans }}</option>
                                <option value="7" {% if filterDays == 7 and not filterDateFrom and not filterDateTo %}selected{% endif %}>7 {{ 'mautic.bpmessage.days'|trans }}</option>
                                <option value="14" {% if filterDays == 14 and not filterDateFrom and not filterDateTo %}selected{% endif %}>14 {{ 'mautic.bpmessage.days'|trans }}</option>
                                <option value="30" {% if filterDays == 30 and not filterDateFrom and not filterDateTo %}selected{% endif %}>30 {{ 'mautic.bpmessage.days'|trans }}</option>
                                <option value="60" {% if filterDays == 60 and not filterDateFrom and not filterDateTo %}selected{% endif %}>60 {{ 'mautic.bpmessage.days'|trans }}</option>
                                <option value="90" {% if filterDays == 90 and not filterDateFrom and not filterDateTo %}selected{% endif %}>90 {{ 'mautic.bpmessage.days'|trans }}</option>
                                <option value="custom" {% if filterDateFrom or filterDateTo %}selected{% endif %}>{{ 'mautic.bpmessage.filter.custom_range'|trans }}</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2" id="date-from-container" style="{% if not filterDateFrom and not filterDateTo %}display:none;{% endif %}">
                        <div class="form-group">
                            <label>{{ 'mautic.bpmessage.filter.date_from'|trans }}</label>
                            <input type="date" name="date_from" class="form-control" value="{{ filterDateFrom }}">
                        </div>
                    </div>
                    <div class="col-md-2" id="date-to-container" style="{% if not filterDateFrom and not filterDateTo %}display:none;{% endif %}">
                        <div class="form-group">
                            <label>{{ 'mautic.bpmessage.filter.date_to'|trans }}</label>
                            <input type="date" name="date_to" class="form-control" value="{{ filterDateTo }}">
                        </div>
                    </div>
                    <div class="col-md-2" id="filter-buttons-container">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-default">
                                    <i class="fa fa-filter"></i> {{ 'mautic.bpmessage.filter.button'|trans }}
                                </button>
                                {% if filterStatus or filterType or filterCampaign or filterDays > 0 or filterDateFrom or filterDateTo %}
                                    <a href="{{ path('mautic_bpmessage_lot_index') }}" class="btn btn-link">
                                        <i class="fa fa-times"></i> {{ 'mautic.bpmessage.filter.clear'|trans }}
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <script>
                function handleDaysChange(select) {
                    var dateFromContainer = document.getElementById('date-from-container');
                    var dateToContainer = document.getElementById('date-to-container');
                    if (select.value === 'custom') {
                        dateFromContainer.style.display = '';
                        dateToContainer.style.display = '';
                    } else {
                        dateFromContainer.style.display = 'none';
                        dateToContainer.style.display = 'none';
                        document.querySelector('input[name="date_from"]').value = '';
                        document.querySelector('input[name="date_to"]').value = '';
                        select.form.submit();
                    }
                }
                </script>
            </form>
        </div>
    </div>

    {# Results count #}
    <div class="mb-2">
        <span class="text-muted">
            {{ 'mautic.bpmessage.results'|trans({'%count%': totalCount}) }}
        </span>
    </div>

    <div class="panel-body">
        {% if lots|length == 0 %}
            <div class="alert alert-info">
                <i class="fa fa-info-circle"></i> {{ 'mautic.bpmessage.lot.none'|trans }}
            </div>
        {% else %}
            <div class="table-responsive">
                <table class="table table-hover table-bordered">
                    <thead>
                        <tr>
                            <th class="col-lot-id">{{ 'mautic.bpmessage.lot.col.id'|trans }}</th>
                            <th class="col-lot-type">{{ 'mautic.bpmessage.lot.col.type'|trans }}</th>
                            <th class="col-lot-name">{{ 'mautic.bpmessage.lot.col.name'|trans }}</th>
                            <th class="col-lot-external-id">{{ 'mautic.bpmessage.lot.external_id'|trans }}</th>
                            <th class="col-lot-campaign">{{ 'mautic.bpmessage.lot.col.campaign'|trans }}</th>
                            <th class="col-lot-status">{{ 'mautic.bpmessage.lot.col.status'|trans }}</th>
                            <th class="col-lot-error">{{ 'mautic.bpmessage.lot.col.error'|trans }}</th>
                            <th class="col-lot-messages">{{ 'mautic.bpmessage.messages'|trans }}</th>
                            <th class="col-lot-created">{{ 'mautic.bpmessage.lot.col.created'|trans }}</th>
                            <th class="col-lot-actions">{{ 'mautic.bpmessage.lot.col.actions'|trans }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lot in lots %}
                            {% set stats = lotStats[lot.id] %}
                            <tr>
                                <td>
                                    <a href="{{ path('mautic_bpmessage_lot_view', {'id': lot.id}) }}" data-toggle="ajax">
                                        #{{ lot.id }}
                                    </a>
                                </td>
                                <td class="text-center">
                                    {% if lot.emailLot %}
                                        Email
                                    {% elseif lot.serviceType == 1 %}
                                        WhatsApp
                                    {% elseif lot.serviceType == 2 %}
                                        SMS
                                    {% elseif lot.serviceType == 4 %}
                                        RCS
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {{ lot.name }}
                                </td>
                                <td>
                                    {% if lot.externalLotId %}
                                        <code>{{ lot.externalLotId }}</code>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if lot.campaignId %}
                                        {% if campaigns[lot.campaignId] is defined %}
                                            <a href="{{ path('mautic_campaign_action', {'objectAction': 'view', 'objectId': lot.campaignId}) }}" target="_blank">
                                                {{ campaigns[lot.campaignId] }}
                                            </a>
                                        {% else %}
                                            Campaign #{{ lot.campaignId }}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if lot.status == 'CREATING' %}
                                        <span class="label label-info">{{ 'mautic.bpmessage.lot.status.creating'|trans }}</span>
                                    {% elseif lot.status == 'OPEN' %}
                                        <span class="label label-warning">{{ 'mautic.bpmessage.lot.status.open'|trans }}</span>
                                    {% elseif lot.status == 'FINISHED' %}
                                        <span class="label label-success">{{ 'mautic.bpmessage.lot.status.finished'|trans }}</span>
                                    {% elseif lot.status == 'FAILED' or lot.status == 'FAILED_CREATION' %}
                                        <span class="label label-danger">{{ 'mautic.bpmessage.lot.status.failed'|trans }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {{ stats.failed }}
                                </td>
                                <td class="text-center">
                                    {{ stats.total }}
                                </td>
                                <td>
                                    <span title="{{ lot.createdAt|date('Y-m-d H:i:s') }}">
                                        {{ lot.createdAt|date('Y-m-d H:i') }}
                                    </span>
                                </td>
                                <td style="white-space: nowrap;">
                                    <div class="btn-group" style="display: flex; flex-wrap: nowrap;">
                                        <a href="{{ path('mautic_bpmessage_lot_view', {'id': lot.id}) }}"
                                           class="btn btn-default btn-xs"
                                           data-toggle="ajax">
                                            {{ 'mautic.bpmessage.lot.action.view'|trans }}
                                        </a>
                                        {# Reprocessar: apenas lotes FAILED ou CREATING sem externalLotId - NUNCA para FINISHED #}
                                        {% if lot.status == 'FAILED' or (lot.status == 'CREATING' and not lot.externalLotId) %}
                                            <a href="{{ path('mautic_bpmessage_lot_reprocess', {'id': lot.id}) }}"
                                               class="btn btn-warning btn-xs"
                                               data-toggle="ajax"
                                               data-method="POST">
                                                {{ 'mautic.bpmessage.lot.action.retry'|trans }}
                                            </a>
                                        {% endif %}
                                        {# Processar: lotes prontos para enviar #}
                                        {% if lot.status == 'OPEN' or (lot.status == 'CREATING' and lot.externalLotId) %}
                                            <a href="{{ path('mautic_bpmessage_lot_process_single', {'id': lot.id}) }}"
                                               class="btn btn-primary btn-xs"
                                               data-toggle="ajax"
                                               data-method="POST">
                                                {{ 'mautic.bpmessage.lot.action.process'|trans }}
                                            </a>
                                        {% endif %}
                                        {# Cancelar: lotes em andamento #}
                                        {% if lot.status in ['CREATING', 'OPEN', 'SENDING'] %}
                                            <a href="{{ path('mautic_bpmessage_lot_cancel', {'id': lot.id}) }}"
                                               class="btn btn-danger btn-xs"
                                               data-toggle="ajax"
                                               data-method="POST"
                                               onclick="return confirm('{{ 'mautic.bpmessage.lot.cancel.confirm'|trans }}');">
                                                {{ 'mautic.bpmessage.lot.action.cancel'|trans }}
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {# Pagination #}
            {% if totalPages > 1 %}
                <div class="text-center">
                    <ul class="pagination">
                        {% if page > 1 %}
                            <li>
                                <a href="{{ path('mautic_bpmessage_lot_index', {'page': page - 1, 'status': filterStatus, 'type': filterType, 'campaign_id': filterCampaign, 'days': filterDays, 'date_from': filterDateFrom, 'date_to': filterDateTo}) }}" data-toggle="ajax">
                                    <i class="fa fa-angle-left"></i>
                                </a>
                            </li>
                        {% endif %}

                        {% for p in 1..totalPages %}
                            {% if p <= 3 or p > totalPages - 3 or (p >= page - 2 and p <= page + 2) %}
                                <li {% if p == page %}class="active"{% endif %}>
                                    <a href="{{ path('mautic_bpmessage_lot_index', {'page': p, 'status': filterStatus, 'type': filterType, 'campaign_id': filterCampaign, 'days': filterDays, 'date_from': filterDateFrom, 'date_to': filterDateTo}) }}" data-toggle="ajax">
                                        {{ p }}
                                    </a>
                                </li>
                            {% elseif p == 4 or p == totalPages - 3 %}
                                <li class="disabled"><span>...</span></li>
                            {% endif %}
                        {% endfor %}

                        {% if page < totalPages %}
                            <li>
                                <a href="{{ path('mautic_bpmessage_lot_index', {'page': page + 1, 'status': filterStatus, 'type': filterType, 'campaign_id': filterCampaign, 'days': filterDays, 'date_from': filterDateFrom, 'date_to': filterDateTo}) }}" data-toggle="ajax">
                                    <i class="fa fa-angle-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            {% endif %}
        {% endif %}
    </div>
</div>
{% endblock %}
