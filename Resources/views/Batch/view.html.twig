{% extends '@MauticCore/Default/content.html.twig' %}

{% block headerTitle %}
    {{ 'mautic.bpmessage.lot.header.view'|trans({'%name%': lot.name}) }}
{% endblock %}

{% block actions %}
    <div class="btn-group">
        <a href="{{ path('mautic_bpmessage_lot_index') }}"
           class="btn btn-default btn-sm"
           data-toggle="ajax">
            <i class="fa fa-arrow-left"></i> {{ 'mautic.bpmessage.lot.back'|trans }}
        </a>
        {# Reprocessar: apenas lotes FAILED ou CREATING sem externalLotId - NUNCA para FINISHED #}
        {% if lot.status == 'FAILED' or (lot.status == 'CREATING' and not lot.externalLotId) %}
            <a href="{{ path('mautic_bpmessage_lot_reprocess', {'id': lot.id}) }}"
               class="btn btn-warning btn-sm"
               data-toggle="ajax"
               data-method="POST">
                <i class="fa fa-refresh"></i> {{ 'mautic.bpmessage.lot.reprocess'|trans }}
            </a>
        {% endif %}
        {# Processar: lotes prontos para enviar (OPEN ou CREATING com externalLotId) #}
        {% if lot.status == 'OPEN' or (lot.status == 'CREATING' and lot.externalLotId) %}
            <a href="{{ path('mautic_bpmessage_lot_process_single', {'id': lot.id}) }}"
               class="btn btn-primary btn-sm"
               data-toggle="ajax"
               data-method="POST"
               onclick="return confirm('{{ 'mautic.bpmessage.lot.process.confirm'|trans }}');">
                <i class="fa fa-play"></i> {{ 'mautic.bpmessage.lot.action.process'|trans }}
            </a>
        {% endif %}
        {# Cancelar: apenas lotes em andamento #}
        {% if lot.status in ['CREATING', 'OPEN', 'SENDING'] %}
            <a href="{{ path('mautic_bpmessage_lot_cancel', {'id': lot.id}) }}"
               class="btn btn-danger btn-sm"
               data-toggle="ajax"
               data-method="POST"
               onclick="return confirm('{{ 'mautic.bpmessage.lot.cancel.confirm'|trans }}');">
                <i class="fa fa-times"></i> {{ 'mautic.bpmessage.lot.cancel'|trans }}
            </a>
        {% endif %}
    </div>
{% endblock %}

{% block content %}
<div class="pa-md">
    {# Lot Information #}
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">{{ 'mautic.bpmessage.lot.info'|trans }}</h3>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="dl-horizontal">
                        <dt>{{ 'mautic.core.id'|trans }}:</dt>
                        <dd>#{{ lot.id }}</dd>

                        <dt>{{ 'mautic.core.name'|trans }}:</dt>
                        <dd>{{ lot.name }}</dd>

                        <dt>{{ 'mautic.bpmessage.lot.external_id'|trans }}:</dt>
                        <dd>
                            {% if lot.externalLotId %}
                                <code>{{ lot.externalLotId }}</code>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </dd>

                        <dt>{{ 'mautic.bpmessage.lot.status'|trans }}:</dt>
                        <dd>
                            {% if lot.status == 'CREATING' %}
                                <span class="label label-info">{{ 'mautic.bpmessage.lot.status.creating'|trans }}</span>
                            {% elseif lot.status == 'OPEN' %}
                                <span class="label label-warning">{{ 'mautic.bpmessage.lot.status.open'|trans }}</span>
                            {% elseif lot.status == 'FINISHED' %}
                                <span class="label label-success">{{ 'mautic.bpmessage.lot.status.finished'|trans }}</span>
                            {% elseif lot.status == 'FAILED' %}
                                <span class="label label-danger">{{ 'mautic.bpmessage.lot.status.failed'|trans }}</span>
                            {% endif %}
                        </dd>

                        <dt>{{ 'mautic.campaign.campaign'|trans }}:</dt>
                        <dd>
                            {% if lot.campaignId %}
                                Campaign #{{ lot.campaignId }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </dd>

                        <dt>{{ 'mautic.bpmessage.lot.route'|trans }}:</dt>
                        <dd>
                            {% if routeName %}
                                {{ routeName }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </dd>

                        <dt>{{ 'mautic.bpmessage.lot.crm_id'|trans }}:</dt>
                        <dd>
                            {% if lot.crmId %}
                                <code>{{ lot.crmId }}</code>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </dd>

                        <dt>{{ 'mautic.bpmessage.lot.book_business_foreign_id'|trans }}:</dt>
                        <dd>
                            {% if lot.bookBusinessForeignId %}
                                <code>{{ lot.bookBusinessForeignId }}</code>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </dd>

                        <dt>{{ 'mautic.bpmessage.lot.user_cpf'|trans }}:</dt>
                        <dd><code>{{ lot.userCpf }}</code></dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="dl-horizontal">
                        <dt>{{ 'mautic.bpmessage.lot.api_url'|trans }}:</dt>
                        <dd><code>{{ lot.apiBaseUrl }}</code></dd>

                        <dt>{{ 'mautic.bpmessage.lot.batch_size'|trans }}:</dt>
                        <dd>{{ lot.batchSize }}</dd>

                        <dt>{{ 'mautic.bpmessage.lot.time_window'|trans }}:</dt>
                        <dd>{{ lot.timeWindow }} {{ 'mautic.bpmessage.lot.seconds'|trans }}</dd>

                        <dt>{{ 'mautic.core.date.added'|trans }}:</dt>
                        <dd>{{ lot.createdAt|date('Y-m-d H:i:s') }}</dd>

                        {% if lot.finishedAt %}
                            <dt>{{ 'mautic.bpmessage.lot.finished_at'|trans }}:</dt>
                            <dd>{{ lot.finishedAt|date('Y-m-d H:i:s') }}</dd>
                        {% endif %}

                        <dt>{{ 'mautic.bpmessage.lot.start_date'|trans }}:</dt>
                        <dd>{{ lot.startDate|date('Y-m-d H:i:s') }}</dd>

                        <dt>{{ 'mautic.bpmessage.lot.end_date'|trans }}:</dt>
                        <dd>{{ lot.endDate|date('Y-m-d H:i:s') }}</dd>
                    </dl>
                </div>
            </div>

            {% if lot.errorMessage %}
                <div class="alert alert-danger mt-3" style="margin-top: 15px;">
                    <i class="fa fa-exclamation-triangle"></i> {{ lot.errorMessage }}
                </div>
            {% endif %}
        </div>
    </div>

    {# Statistics #}
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">{{ 'mautic.bpmessage.lot.statistics'|trans }}</h3>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-3 text-center">
                    <h3>{{ statistics.total }}</h3>
                    <p class="text-muted">{{ 'mautic.bpmessage.messages.total'|trans }}</p>
                </div>
                <div class="col-md-3 text-center">
                    <h3 class="text-warning">{{ statistics.pending }}</h3>
                    <p class="text-muted">{{ 'mautic.bpmessage.messages.pending'|trans }}</p>
                </div>
                <div class="col-md-3 text-center">
                    <h3 class="text-success">{{ statistics.sent }}</h3>
                    <p class="text-muted">{{ 'mautic.bpmessage.messages.sent'|trans }}</p>
                </div>
                <div class="col-md-3 text-center">
                    <h3 class="text-danger">{{ statistics.failed }}</h3>
                    <p class="text-muted">{{ 'mautic.bpmessage.messages.failed'|trans }}</p>
                </div>
            </div>
        </div>
    </div>

    {# Messages List #}
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">{{ 'mautic.bpmessage.lot.messages'|trans }} ({{ messages|length }})</h3>
        </div>
        <div class="panel-body">
            {% if messages|length == 0 %}
                <div class="alert alert-info">
                    <i class="fa fa-info-circle"></i> {{ 'mautic.bpmessage.lot.messages.none'|trans }}
                </div>
            {% else %}
                <div class="table-responsive">
                    <table class="table table-hover table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>{{ 'mautic.core.id'|trans }}</th>
                                <th>{{ 'mautic.lead.lead'|trans }}</th>
                                {% if lot.isEmailLot %}
                                    <th>{{ 'mautic.core.email'|trans }}</th>
                                {% else %}
                                    <th>{{ 'mautic.bpmessage.phone'|trans }}</th>
                                {% endif %}
                                <th>{{ 'mautic.core.status'|trans }}</th>
                                <th>{{ 'mautic.bpmessage.error_message'|trans }}</th>
                                <th>{{ 'mautic.bpmessage.retry_count'|trans }}</th>
                                <th>{{ 'mautic.core.date.added'|trans }}</th>
                                <th>{{ 'mautic.core.details'|trans }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for message in messages %}
                                {% set lead = message.lead %}
                                {% set payload = message.payloadArray %}
                                <tr>
                                    <td>#{{ message.id }}</td>
                                    <td>
                                        <a href="{{ path('mautic_contact_action', {'objectAction': 'view', 'objectId': lead.id}) }}"
                                           target="_blank">
                                            {{ lead.firstname }} {{ lead.lastname }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if lot.isEmailLot %}
                                            {% if payload.to is defined and payload.to %}
                                                {{ payload.to }}
                                            {% else %}
                                                {{ lead.email }}
                                            {% endif %}
                                        {% else %}
                                            {% if payload.areaCode is defined and payload.areaCode and payload.phone is defined and payload.phone %}
                                                ({{ payload.areaCode }}) {{ payload.phone }}
                                            {% elseif payload.phone is defined and payload.phone %}
                                                {{ payload.phone }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if message.status == 'PENDING' %}
                                            <span class="label label-warning">{{ 'mautic.bpmessage.message.status.pending'|trans }}</span>
                                        {% elseif message.status == 'SENT' %}
                                            <span class="label label-success">{{ 'mautic.bpmessage.message.status.sent'|trans }}</span>
                                        {% elseif message.status == 'FAILED' %}
                                            <span class="label label-danger">{{ 'mautic.bpmessage.message.status.failed'|trans }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if message.errorMessage %}
                                            <span class="text-danger" title="{{ message.errorMessage }}" data-toggle="tooltip">
                                                {{ message.errorMessage|slice(0, 50) }}{% if message.errorMessage|length > 50 %}...{% endif %}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if message.retryCount > 0 %}
                                            <span class="badge badge-warning">{{ message.retryCount }}</span>
                                        {% else %}
                                            <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ message.createdAt|date('Y-m-d H:i:s') }}</td>
                                    <td class="text-center">
                                        {% if payload._phone_source is defined and payload._phone_source == 'crm_api' %}
                                            <a href="javascript:void(0);" class="btn btn-primary btn-xs" data-toggle="modal" data-target="#detailsModal{{ message.id }}" title="{{ 'mautic.bpmessage.crm_api_details'|trans }}">
                                                <span class="fa fa-eye"></span> {{ 'mautic.bpmessage.lot.action.view_details'|trans }}
                                            </a>

                                            <!-- Modal CRM API -->
                                            <div class="modal fade" id="detailsModal{{ message.id }}" tabindex="-1" role="dialog">
                                                <div class="modal-dialog modal-lg" role="document">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                                                            <h4 class="modal-title">{{ 'mautic.bpmessage.crm_api_details'|trans }} - #{{ message.id }}</h4>
                                                        </div>
                                                        <div class="modal-body">
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <h5><strong>{{ 'mautic.bpmessage.phone_source'|trans }}</strong></h5>
                                                                    <p><span class="label label-info">API CRM</span></p>

                                                                    <h5><strong>{{ 'mautic.bpmessage.cpf_cnpj_used'|trans }}</strong></h5>
                                                                    <p>
                                                                        {# Mask CPF/CNPJ: show only last digits #}
                                                                        {% set cpfCnpj = payload._cpf_cnpj_used|default('') %}
                                                                        {% if cpfCnpj|length == 11 %}
                                                                            {# CPF: ***.***.XXX-XX #}
                                                                            ***.***.<strong>{{ cpfCnpj|slice(6, 3) }}-{{ cpfCnpj|slice(9, 2) }}</strong>
                                                                        {% elseif cpfCnpj|length == 14 %}
                                                                            {# CNPJ: **.***.***/*XXX-XX #}
                                                                            **.***.***/<strong>{{ cpfCnpj|slice(8, 4) }}-{{ cpfCnpj|slice(12, 2) }}</strong>
                                                                        {% elseif cpfCnpj|length > 0 %}
                                                                            {# Partial mask for other formats #}
                                                                            {{ '***' ~ cpfCnpj|slice(-4) }}
                                                                        {% else %}
                                                                            -
                                                                        {% endif %}
                                                                    </p>

                                                                    {% if payload._phone_error is defined %}
                                                                        <h5><strong>{{ 'mautic.bpmessage.error'|trans }}</strong></h5>
                                                                        <p class="text-danger">{{ payload._phone_error }}</p>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="col-md-6">
                                                                    {% if payload._selected_phone is defined %}
                                                                        <h5><strong>{{ 'mautic.bpmessage.selected_phone'|trans }}</strong></h5>
                                                                        <table class="table table-condensed table-bordered">
                                                                            <tr>
                                                                                <th>{{ 'mautic.bpmessage.phone'|trans }}</th>
                                                                                <td>{{ payload._selected_phone.numero|default('-') }}</td>
                                                                            </tr>
                                                                            <tr>
                                                                                <th>{{ 'mautic.bpmessage.score'|trans }}</th>
                                                                                <td><span class="badge badge-success">{{ payload._selected_phone.pontuacao|default(0) }}</span></td>
                                                                            </tr>
                                                                            <tr>
                                                                                <th>CRM</th>
                                                                                <td>{{ payload._selected_phone.crm|default('-') }}</td>
                                                                            </tr>
                                                                        </table>
                                                                    {% endif %}
                                                                </div>
                                                            </div>

                                                            {% if payload._crm_phones_list is defined and payload._crm_phones_list|length > 0 %}
                                                                <hr>
                                                                <h5><strong>{{ 'mautic.bpmessage.all_phones_from_api'|trans }}</strong> ({{ payload._crm_phones_list|length }})</h5>
                                                                <div class="table-responsive">
                                                                    <table class="table table-condensed table-bordered table-striped">
                                                                        <thead>
                                                                            <tr>
                                                                                <th>#</th>
                                                                                <th>{{ 'mautic.bpmessage.phone'|trans }}</th>
                                                                                <th>{{ 'mautic.bpmessage.score'|trans }}</th>
                                                                                <th>CRM</th>
                                                                                <th>{{ 'mautic.bpmessage.selected'|trans }}</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            {% for idx, phone in payload._crm_phones_list %}
                                                                                {% set isSelected = payload._selected_phone is defined and payload._selected_phone.numero is defined and phone.numero == payload._selected_phone.numero %}
                                                                                <tr class="{{ isSelected ? 'success' : '' }}">
                                                                                    <td>{{ idx + 1 }}</td>
                                                                                    <td>{{ phone.numero }}</td>
                                                                                    <td><span class="badge">{{ phone.pontuacao }}</span></td>
                                                                                    <td>{{ phone.crm|default('-') }}</td>
                                                                                    <td class="text-center">
                                                                                        {% if isSelected %}
                                                                                            <span class="label label-success">&#10003;</span>
                                                                                        {% else %}
                                                                                            <span class="text-muted">-</span>
                                                                                        {% endif %}
                                                                                    </td>
                                                                                </tr>
                                                                            {% endfor %}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-default" data-dismiss="modal">{{ 'mautic.core.close'|trans }}</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% elseif payload._phone_source is defined and payload._phone_source == 'lead' and payload._lead_phones_list is defined and payload._lead_phones_list|length > 1 %}
                                            <a href="javascript:void(0);" class="btn btn-info btn-xs" data-toggle="modal" data-target="#detailsModal{{ message.id }}" title="{{ 'mautic.bpmessage.lead_phone_details'|trans }}">
                                                <span class="fa fa-eye"></span> {{ 'mautic.bpmessage.lot.action.view_details'|trans }}
                                            </a>

                                            <!-- Modal Lead Phone -->
                                            <div class="modal fade" id="detailsModal{{ message.id }}" tabindex="-1" role="dialog">
                                                <div class="modal-dialog modal-lg" role="document">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                                                            <h4 class="modal-title">{{ 'mautic.bpmessage.lead_phone_details'|trans }} - #{{ message.id }}</h4>
                                                        </div>
                                                        <div class="modal-body">
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <h5><strong>{{ 'mautic.bpmessage.phone_source'|trans }}</strong></h5>
                                                                    <p><span class="label label-default">{{ 'mautic.bpmessage.lead_field'|trans }}</span></p>

                                                                    <h5><strong>{{ 'mautic.bpmessage.phone_field_used'|trans }}</strong></h5>
                                                                    <p>{{ payload._phone_field|default('-') }}</p>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    {% if payload._selected_phone is defined %}
                                                                        <h5><strong>{{ 'mautic.bpmessage.selected_phone'|trans }}</strong></h5>
                                                                        <table class="table table-condensed table-bordered">
                                                                            <tr>
                                                                                <th>{{ 'mautic.bpmessage.phone'|trans }}</th>
                                                                                <td>{{ payload._selected_phone.numero|default('-') }}</td>
                                                                            </tr>
                                                                            <tr>
                                                                                <th>{{ 'mautic.bpmessage.area_code'|trans }}</th>
                                                                                <td>{{ payload._selected_phone.areaCode|default('-') }}</td>
                                                                            </tr>
                                                                        </table>
                                                                    {% endif %}
                                                                </div>
                                                            </div>

                                                            <hr>
                                                            <h5><strong>{{ 'mautic.bpmessage.all_phones_from_lead'|trans }}</strong> ({{ payload._lead_phones_list|length }})</h5>
                                                            <div class="table-responsive">
                                                                <table class="table table-condensed table-bordered table-striped">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>#</th>
                                                                            <th>{{ 'mautic.bpmessage.phone'|trans }}</th>
                                                                            <th>{{ 'mautic.bpmessage.area_code'|trans }}</th>
                                                                            <th>{{ 'mautic.bpmessage.selected'|trans }}</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        {% for idx, phone in payload._lead_phones_list %}
                                                                            {% set isSelected = payload._selected_phone is defined and payload._selected_phone.numero is defined and phone.numero == payload._selected_phone.numero %}
                                                                            <tr class="{{ isSelected ? 'success' : '' }}">
                                                                                <td>{{ idx + 1 }}</td>
                                                                                <td>{{ phone.numero }}</td>
                                                                                <td>{{ phone.areaCode|default('-') }}</td>
                                                                                <td class="text-center">
                                                                                    {% if isSelected %}
                                                                                        <span class="label label-success">&#10003;</span>
                                                                                    {% else %}
                                                                                        <span class="text-muted">-</span>
                                                                                    {% endif %}
                                                                                </td>
                                                                            </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-default" data-dismiss="modal">{{ 'mautic.core.close'|trans }}</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
